# GNLM-RFM
Random forest model variables for nitrate loading in groundwater wells.


## About
Tools for automating the extraction of GNLM data for analysis of groundwater wells in the central valley.

Please contact Andy Bell (ambell@ucdavis.edu) with issues. 

## Requirements

Tools should work in any version of ArcGIS > 10.0 with the Spatial Analyst License. The tools do require the Spatial Analyst Supplemental Toolbox (http://blogs.esri.com/esri/arcgis/2013/01/17/introducing-the-spatial-analyst-supplemental-tools/) which are included in the tbx folder.

Note: the spatial analyst supplemental tools require a lot of memory when processing. If you get errors, try splitting the dataset into smaller chucks. 


## Methods

Each well is turned in to a separate polygon using a 1.5 mile radius buffer. Every well should have a unique id that can be used to join the result tables. Since the buffers have overlapping sections, the tools in the gnlm-rfm.pyt toolbox use the spatial analyst supplemental tools which creates groupings with no overlaps and then merges the results.


## Tools
All tools are bundled in an ArcGIS python toolbox. The tools can be run using either ArcMap or ArcCatalog.

GNLM-RFM.pyt

 - Buffer: Copies input points to the results geodatabase and creates a circular buffer around each well. Important: inputs should have a unique field prior to using the tool. You can change the default name for the ID field in config.py file. The buffer distance can also be changed in the config file.
 - Tabulate CAML area: tabulates the amount of area within each of the well buffers for each of the caml datasets. Tool creates a table for each year with the amount of area (in the units of the input raster) in each buffer for all of the input periods selected.
 - Reclass CAML area from CSV: summarizes new classes from a csv file using the table generated by the tabulate CAML area tool. Useful since it does not require rerunning the tabulate area for each polygon.
 - Add Bioclim Data: Extracts all values for the bands of the WorldClim climate raster to a table for each of the points.
 - Add CVHM Data: Calculates the average soil texture within the buffers for the depths within the top 400ft. Tool selects the cvhm centroids of the grid cells that intersect with the buffer.
 - Atmospheric N Deposition: Zonal statistics for the N deposition values within the buffer polygon.
 - Groundwater Depth: Zonal statistics for the ground water depth within each buffer polygon.
 - Distance to Major River: Distance to the nearest major river (Modified Strahler Stream Order > 3) segment for each point.
 - Num. People on Septics Systems: Tabulates an approximation of the number of people on septic systems within the buffer using zonal stats "sum".
 - GNLM AREA: Tabulates the amount of area within each of the buffers for each of the groups in the GNLM Direct App Rasters. 
 - N load GNLM variables: Sums the Kg N per year for the GNLM variable within the buffer. Raster values should be kg of N per year.
 

## Predictor Grid 

The ArcGIS fishnet tool was used to create evenly spaced points to create a 1.5 mile (2414.020828 meters) grid for the study extent in the Central Valley. Only points that were within 3 miles of the ground water basin boundrary were retained. Each point in the grid was then buffered 1.5 miles using the gnlm-rfm/Buffer tool. 


## Data Sources

### CAML - California augmented multi-source landuse.

The files used for the CAML landuse data products from the nitrates 2015 GNLM work. Data was cliped to the GNLM study extent region for all of the time periods (1945, 1960, 1975, 1990, 2005). Raster data is in meters, so the results for the tabulated areas are in square meters. 

Issue with CAML 1990 raster groups (212910, 212911, 212912, 212913, 212914, 212915) when tabulating area. Unknown error was preventing about a tenth of records from properly being merged (missing values for the well IDs). Not sure the cause (maybe field length?). Solved by truncating the first two digits off of the value using a reclassified raster (ie: 212910 -> 2910). These classes are only present in CAML 1990, all other time periods working properly. 

### Septics

Data from GNLM inputs, which was derived from work by Aaron King. Raster values represents the number of people on septics systems per hectacre (50m cell). Total number of people on septics for the buffer is simply the sum of all cells within the buffer. Null or missing values represent natural areas or areas that are covered by sewer systems.

### Bioclim

Bioclim raster contains monthly temperature and rainfall values. See WorldClim (http://www.worldclim.org/bioclim) for more info. Useful bands include:
- BIO12 = Annual Precipitation (units are mm)
- BIO13 = Precipitation of Wettest Month
- BIO14 = Precipitation of Driest Month
- BIO15 = Precipitation Seasonality (Coefficient of Variation)
- BIO16 = Precipitation of Wettest Quarter
- BIO17 = Precipitation of Driest Quarter
- BIO18 = Precipitation of Warmest Quarter
- BIO19 = Precipitation of Coldest Quarter

### CVHM 

CVHM Soil texture contains the percent coarse soil texture for a profile of depths. Only interested in the upper 8 depths (400ft). 

### Depth to Groundwater

Depth to groundwater raster from DWR. Converted DWR_SPRING2012_DTW_ft.tif to meters proir to doing zonal stats within the buffers.

### Distance to Major Rivers

Major river in the Central Valley were derived from the National Hydrography Dataset (NHD) flowlines. Major rivers in CA were selected from the NHDplus v2 data by joining NHDFlowlineVAA table to the NHDflowlines and selecting only the Modified Strahler Stream Order (StreamOrde) above 3. Distance is calculated using ```arcpy.Near_analysis()``` to find the closest river segment to the input point. 

### N deposition

#### Data
Tonnesen, G., Z. Wang, M. Omary, and C. J. Chien. 2007.
Assessment of Nitrogen Deposition: Modeling and Habitat Assessment.
California Energy Commission, PIER Energy-Related Environmental Research. CEC-500-2006-032.
http://www.energy.ca.gov/publications/displayOneReport.php?pubNum=CEC-500-2006-032


Provides a geography of annual nitrogen deposition throughout most of the state of California including locations where there are no measurement data.  Supports study of effect of anthropogenic nitrogen on the structure and function of terrestrial ecosystems.

CMAQ model output for total annual (wet & dry) deposition of reduced species of N (NH3, NH4) and oxidized species of N (NO, NO2, NO3, N2O5, HNO3, HONO, & PAN) during all of 2002 throughout portions of California and Nevada.  Model data are supplied by the Biocomplexity Project atmospheric modeling group at College of Engineering/ Center for Environmental Research and Technology (CE-CERT) under direction of Gail Tonnesen.  This 4 Km resolution raster dataset of model output is provided by the Center for Conservation Biology at the University of California - Riverside as a data product of the Biocomplexity Project, funded by NSF-DEB 0421530.

#### Methods

N Deposition raster for California was resampled to 50m resolution using a bilinear interpolation. Used the ArcGIS Resample (Data Management) tool. Snapped to GW basin boundaries and masked to study extant.  Data was produced for the Expanded Central Valley Groundwater Nitrates Loading Model (GNLM) in April 2015.

### GNLM data

#### AREA

GNLM direct app rasters reclassified to collapse major groups. 2 = lagoons, 3 = corrals, 1000 = dairies (1xxx - 2xxx), 3000 = Food processors (3xxx - 35xx), 3500 = WWTP (35xx), 4000 = biosolids (4xxx), 6000 = perc basins (6xxx). 

#### KgNYr

N rates for facilities and dairies were joined to the GNLM dirapp combined 2005 rasters using the FACIDs. The n rate was spread evenly on all pixels assigned to each facility. The raster was then split based on type (biosolids, food processors, waste water treatment plants, biosoids, perc basins at food processors and perc basins at waste water treatment plants. These new rasters were then set to the kgNyr field using the Lookup tool. The raster with KgNyr values can be found in \gnlm\DirApp2005\DirecAppComb_2005_KgNyr_groups.

## Exporting data

Data tables are exported from the geodatabase to .dbf using the Table to dBase (multiple) tool. The dbase files can be read in R using the foreign package's tools read.dbf(). 